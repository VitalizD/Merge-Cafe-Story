using Enums;
using Gameplay;
using Gameplay.Field;
using Gameplay.ItemGenerators;
using Service;
using System;
using UnityEngine;

namespace EventHandlers
{
    [RequireComponent(typeof(InformationWindow))]
    public class InfoWindowHandler : MonoBehaviour
    {
        private const string _highlightColor = "white";

        private InformationWindow _informationWindow;

        public static event Func<ItemType, bool> IsGenerator;
        public static event Func<ItemType, int, bool> IsGeneratorMaxLevel;
        public static event Func<ItemType, int> GetGeneratorLevel;
        public static event Func<ItemType, Sprite[]> GetProducedItemSprites;

        private void Awake()
        {
            _informationWindow = GetComponent<InformationWindow>();
        }

        private void OnEnable()
        {
            Item.CursorHoveredMovableItem += OnCursorHoveredItem;
            Item.CursorHoveredNotMovableItem += OnCursorHoveredItem;
            Item.CursorLeftItem += _informationWindow.Hide;
            Upgradable.CursorHoveredGenerator += OnCursorHoveredGenerator;
            Upgradable.CursorLeftGenerator += _informationWindow.Hide;
        }

        private void OnDisable()
        {
            Item.CursorHoveredMovableItem -= OnCursorHoveredItem;
            Item.CursorHoveredNotMovableItem -= OnCursorHoveredItem;
            Item.CursorLeftItem -= _informationWindow.Hide;
            Upgradable.CursorHoveredGenerator -= OnCursorHoveredGenerator;
            Upgradable.CursorLeftGenerator -= _informationWindow.Hide;
        }

        private void OnCursorHoveredItem(ItemType type, int level)
        {
            var storage = GameStorage.Instance;
            var itemDescription = Translation.GetItemDescription(type, level);
            var instruction = "";
            var maxLevel = storage.IsItemMaxLevel(type, level);
            Translation.ItemDescription nextDescription = null;

            if (!maxLevel)
                nextDescription = Translation.GetItemDescription(type, level + 1);

            var isGenerator = IsGenerator?.Invoke(type);
            if (isGenerator.GetValueOrDefault())
            {
                var isGeneratorMaxLevel = IsGeneratorMaxLevel?.Invoke(type, level);
                if (isGeneratorMaxLevel.GetValueOrDefault())
                    instruction = $"Перетащи на оборудование <color={_highlightColor}>«{itemDescription.Title}»</color>, чтобы улучшить его.\n\n" +
                        $"Этот предмет нельзя выбросить.";
                else
                {
                    var currentLevel = GetGeneratorLevel?.Invoke(type);
                    var titleNextLevel = Translation.GetItemDescription(type, level + 1).Title;
                    var titleNeedLevel = Translation.GetItemDescription(type, currentLevel.GetValueOrDefault()).Title;
                    instruction = $"Объедини, чтобы получить <color={_highlightColor}>«{titleNextLevel}» {level + 1}-го уровня</color>.\n\n" +
                        $"Получи <color={_highlightColor}>«{titleNeedLevel}» {currentLevel.GetValueOrDefault()}-го уровня</color>, чтобы улучшить оборудование <color={_highlightColor}>«{titleNeedLevel}»</color>.\n\n" +
                        $"Этот предмет нельзя выбросить.";
                }
            }
            else if (type == ItemType.Brilliant)
            {
                var currencyCount = storage.GetBrilliantsRewardByItemlevel(level);
                var brilliantWord = Translation.PluralizeWord(currencyCount, "кристалл", "кристалла", "кристаллов");
                if (maxLevel)
                    instruction = $"Нажми, чтобы получить {currencyCount} {brilliantWord}.";
                else
                    instruction = $"Нажми, чтобы получить {currencyCount} {brilliantWord}, " +
                        $"или объедини, чтобы их стало больше.";
            }
            else if (type == ItemType.Star)
            {
                var currencyCount = storage.GetStarsRewardByItemLevel(level);
                var starWord = Translation.PluralizeWord(currencyCount, "звезду", "звезды", "звёзд");
                if (maxLevel)
                    instruction = $"Нажми, чтобы получить {currencyCount} {starWord}.";
                else
                    instruction = $"Нажми, чтобы получить {currencyCount} {starWord}, " +
                        $"или объедини, чтобы их стало больше.";
            }
            else if (type == ItemType.Present)
            {
                if (maxLevel)
                    instruction = "Нажми, чтобы открыть.";
                else
                    instruction = "Нажми, чтобы открыть, или объедини, чтобы получить более ценный подарок.";
            }
            else if (type == ItemType.OpenPresent)
                instruction = "Нажми, чтобы получить награды!";
            else if (type == ItemType.Key)
            {
                if (maxLevel)
                    instruction = $"Перетащи на замок {level}-го уровня, чтобы разблокировать ячейку.";
                else
                    instruction = $"Перетащи на замок {level}-го уровня, чтобы разблокировать ячейку, " +
                        $"или объедини, чтобы открывать замки более высоких уровней.";
            }
            else if (type == ItemType.Lock)
                instruction = $"Перетащи сюда ключ {level}-го уровня, чтобы разблокировать ячейку.";
            else if (type == ItemType.Box)
            {
                if (maxLevel)
                    instruction = "Нажми, чтобы получить предмет максимального уровня, необходимый для выполнения заказа.";
                else if (level == 2)
                    instruction = $"Нажми, чтобы получить случайный предмет, необходимый для выполнения заказа, или объедини, чтобы получить «{nextDescription.Title}».";
                else if (level == 1)
                    instruction = $"Объедини, чтобы получить «{nextDescription.Title}».";
            }
            else if (type == ItemType.Energy)
            {
                var energyCount = GameStorage.Instance.GetEnergyRewardByItemlevel(level);
                if (maxLevel)
                    instruction = $"Перетащи на генератор, чтобы ускорить его (заряда хватит на {energyCount} " +
                        $"{Translation.PluralizeWord(energyCount, "предмет", "предмета", "предметов")}).";
                else
                instruction = $"Перетащи на генератор, чтобы ускорить его (заряда хватит на {energyCount} " +
                    $"{Translation.PluralizeWord(energyCount, "предмет", "предмета", "предметов")}), или объедини, " +
                    $"чтобы усилить эффект.";


            }
            else
            {
                if (maxLevel)
                    instruction = $"Перетащи на окно заказа, чтобы выполнить его, если он содержит «{itemDescription.Title}».";
                else
                    instruction = $"Перетащи на окно заказа, чтобы выполнить его, если он содержит «{itemDescription.Title}», или объедини, чтобы получить «{nextDescription.Title}».";
            }

            _informationWindow.ShowItem(itemDescription.Title, level, itemDescription.Description, instruction);
        }

        private void OnCursorHoveredGenerator(ItemType type, int level)
        {
            var itemDescription = Translation.GetItemDescription(type, level);

            if (type == ItemType.TrashCan)
            {
                var instruction = "Перетащи сюда предмет, чтобы выбросить его.\n\nУлучши, чтобы можно было продавать предметы.";
                if (level > 2)
                    instruction = "Перетащи сюда предмет, чтобы продать его.\n\nУлучши, чтобы продажа приносила больше бриллиантов.";
                _informationWindow.ShowGenerator(itemDescription.Title, level, itemDescription.Description, null, instruction);
            }
            else
            {
                _informationWindow.ShowGenerator(itemDescription.Title, level,
                    itemDescription.Description, GetProducedItemSprites?.Invoke(type));
            }
        }
    }
}
